<!DOCTYPE html>
<html>

<head>

    <meta charset="utf-8">
    <meta name="viewport"
        content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <title>DOCSYS - Perfil</title>
    <link href="stylesheets/snackbar.css" rel="stylesheet" type="text/css" />
    <script src="javascripts/snackbar.js" type="text/javascript"></script>
    <link href="stylesheets/tooltip.css" rel="stylesheet" type="text/css" />
    <script src="//code.jquery.com/jquery-1.11.1.min.js" type="text/javascript"></script>
    <script src="javascripts/jquery-ui-1.12.1/jquery-ui.js" type="text/javascript"></script>
    <link rel="stylesheet" media="screen" href="stylesheets/formularioUsuario.css">
    <link href="stylesheets/general.css" rel="stylesheet" type="text/css" />
    <link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.0/css/bootstrap.min.css" rel="stylesheet" id="bootstrap-css">
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.0/js/bootstrap.min.js"></script>
    <link href="/stylesheets/indexUsr.css" rel="stylesheet" type="text/css" />
    <link href="/stylesheets/style.css" rel="stylesheet" type="text/css" />
    <script src="/javascripts/modernizr-custom.js" type="text/javascript"></script>
    <script src="/javascripts/DataTables/datatables.js" type="text/javascript"></script>
    <link rel="stylesheet" href="//use.fontawesome.com/releases/v5.3.1/css/all.css">
    <link rel="stylesheet" href="//cdn.datatables.net/1.10.19/css/dataTables.bootstrap4.min.css">
    <link rel="stylesheet" href="//cdn.datatables.net/responsive/2.2.3/css/responsive.bootstrap.min.css">
</head>

<body>
    <div class="loader-wraper">
        <div class="loader">
            <div class="duo duo1">
                <div class="dot dot-a"></div>
                <div class="dot dot-b"></div>
            </div>
            <div class="duo duo2">
                <div class="dot dot-a"></div>
                <div class="dot dot-b"></div>
            </div>
            <br /><br />
            <p>Cargando...</p>
        </div>
        <div style="text-align: center; margin-top: calc(100vh - 80px);">
            <p>Recargue la pagina si este mensaje no desaparece en 5 segundos.</p>
        </div>
    </div>
    <nav class="navbar navbar-inverse top-bar navbar-fixed-top">
        <div class="container-fluid">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#myNavbar"
                    id="mnvar" aria-expanded="false">
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button> <span class="menu-icon" id="menu-icon" style="line-height: 30px; width: 50px"><i
                        class="fa fa-bars" aria-hidden="true" id="chang-menu-icon"></i></span>
                <a class="navbar-brand mx-auto mx-auto-top" href="javascript:goToStart()"
                    style="text-shadow: 0 0 5px black, 0 0 10px rgba(0,0,0,.3);color: white; font-size: 30px; vertical-align: middle; line-height: 30px">DOC<span
                        style="text-shadow: 0 0 3.5px black; color: #3399ff">SYS</span></a>
            </div>
            <div class="collapse navbar-collapse navbar-right" id="myNavbar">
                <ul class="nav navbar-nav">
                    <li id='profileLink' style="display: none"> <a href="javascript:goToProfile()"><i
                                class="fa fa-user"></i> Perfil</a> </li>
                    <li> <a href="javascript:logout()"><i class="fa fa-power-off"></i> Salir</a> </li>
                </ul>
            </div>
        </div>
    </nav>
    <!--    top nav end===========-->
    <div class="wrapper" id="wrapper">
        <div class="left-container" id="left-container">
            <!-- begin SIDE NAV USER PANEL -->
            <div class="hide-sidebar" id="show-nav">
                <ul id="side" class="side-nav">
                </ul>
            </div>
            <!-- END SIDE NAV USER PANEL -->
        </div>
        <div class="right-container full-width" id="right-container">
            <div class="container-fluid" id="mainContainer">
                <div class="row">
                    <div class="col-md-4">
                        <ul class="breadcrumb">
                            <li><i class="fa fa-home"></i><a href="javascript:goToStart()"> Inicio </a></li>
                            <li class="active">Perfil</li>
                        </ul>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <div class="main-header">
                            <h2>Perfil</h2>
                            <em id="usrName">Modificación de usuario</em>
                        </div>
                    </div>
                </div>
            </div>
            <div class="contenedor_principal" style="text-align: center">
                <form class="form_nuevo_usuario" id="form_usuario">
                    <ul>
                        <li>
                            <h2 class="titulo_formulario">Modificar tu información</h2>
                        </li>
                        <li>
                            <h3>Información de contacto</h3>
                            <hr style="max-width: 380px">
                            <div class="tooltip">
                                <label for="nombre_usuario">Nombre</label>
                                <input maxlength="50" type="text" id="nombre" name="nombre_usuario"
                                    onkeypress="return validarLetras(event)">
                                <span class="tooltiptext">Tu nombre</span>
                            </div>
                            <hr style="max-width: 380px">
                            <div class="tooltip">
                                <label for="correo_usuario">Correo</label>
                                <input maxlength="50" type="text" id="correo" name="correo_usuario">
                                <span class="tooltiptext">Con lo que se iniciará sesión
                                    `example@example.com`</span>
                            </div>
                            <hr style="max-width: 380px">
                            <input maxlength="50" class="button button_green" type="button" id="enviar" value="Guardar">
                        </li>
                        <li>
                            <h3>Autenticación</h3>
                            <hr style="max-width: 380px">
                            <div class="tooltip">
                                <label for="contOld">Contraseña actual</label>
                                <input maxlength="50" class="input_text" type="password" id="passOld" name="contOld">
                                <span class="tooltiptext">Ejemplo: 8?Jk7Ecd</span>
                            </div>
                            <hr style="max-width: 380px">
                            <div class="tooltip">
                                <label for="contNew">Contraseña nueva</label>
                                <input maxlength="50" class="input_text" type="password" id="passNew" name="contNew">
                                <span class="tooltiptext">Ejemplo: 8?Jk7Ecd</span>
                            </div>
                            <hr style="max-width: 380px">
                            <div class="tooltip">
                                <label for="contNew">Repita la contraseña</label>
                                <input maxlength="50" class="input_text" type="password" id="passNewR" name="contNew">
                                <span class="tooltiptext">Ejemplo: 8?Jk7Ecd</span>
                            </div>
                            <hr style="max-width: 380px">
                            <input maxlength="50" class="button button_green" type="button" id="enviarPass"
                                value="Cambiar">
                        </li>
                    </ul>
                </form>
            </div>
            <script>
                $(document).ready(function () {
                    user = JSON.parse(localStorage.getItem('user'))
                    user && $('#usrName').html(`Modificacion de usuario | <b>${user.name}</b>`);

                    $("#enviar").click(enviar);
                    $("#enviarPass").click(updatePass);
                    $("#nombre").hover(_ => $("#nombre").removeClass('error'))
                    $("#correo").hover(_ => $("#correo").removeClass('error'))
                    $('#passNew').hover(_ => $('#passNew').removeClass('error'))
                    $('#passNewR').hover(_ => $('#passNewR').removeClass('error'))
                    $('#passOld').hover(_ => $('#passOld').removeClass('error'))
                    fetch('/creUsrNav', {
                        method: 'GET'
                    }).then(async e => {
                        nav = await e.text()
                        $("#side").html(nav)
                        type = JSON.parse(localStorage.getItem('user')).type
                        /*if(type==1||type==2)
                            $('#tipo').html(`${$('#tipo').html()}<option value="4" active>Trabajador</option>`)*///preguntar a pablo
                    });
                    $.ajax({
                        type: 'GET',
                        url: '/api/user/info'
                    }).done(response => {
                        if (response.name) {
                            user = response
                            $("#nombre").val(user.name)
                            $("#correo").val(user.email)
                            $('.loader-wraper').fadeOut()
                        }
                    }).fail(_ => window.logation = 'http://localhost:3000/forbiden.html')
                    $(".filter-button").click(function () {
                        var value = $(this).attr('data-filter');

                        if (value == "all") {
                            //$('.filter').removeClass('hidden');
                            $('.filter').show('1000');
                        }
                        else {
                            //            $('.filter[filter-item="'+value+'"]').removeClass('hidden');
                            //            $(".filter").not('.filter[filter-item="'+value+'"]').addClass('hidden');
                            $(".filter").not('.' + value).hide('1900');
                            $('.filter').filter('.' + value).show('2000');
                        }
                        $('.button-left').click(function () {
                            $('.sidebar').toggleClass('fliph');
                        });

                    });

                    $("#menu-icon").click(function (e) {
                        e.stopPropagation();
                        $("#chang-menu-icon").toggleClass("fa-bars").toggleClass("fa-times");
                        if (!$('#mnvar').hasClass('collapsed')) { $("#show-nav").css('margin-top', '50px') }
                        else { $("#show-nav").css('margin-top', '0px') }
                        $("#show-nav").toggleClass("hide-sidebar").toggleClass("left-sidebar");

                        //$("#left-container").toggleClass("less-width");
                        //$("#right-container").toggleClass("full-width");
                    });
                    $('body').click(e => {
                        element = $("#show-nav")[0]
                        if (element != e.target && !element.contains(e.target) && $("#show-nav").hasClass("left-sidebar")) {
                            $("#chang-menu-icon").toggleClass("fa-bars").toggleClass("fa-times");
                            $("#show-nav").toggleClass("hide-sidebar").toggleClass("left-sidebar");
                        }
                    })

                    if ($(".filter-button").removeClass("active")) {
                        $(this).removeClass("active");
                    }

                });
                const logout = () => {
                    fetch(`./api/user/auth/logout`, {
                        method: 'GET',
                        credentials: "include"
                    }).then(() => {
                        localStorage.removeItem('org')
                        localStorage.removeItem('user')
                        setTimeout(() => window.location.reload(), 1)
                    })
                }
                const goToDump = () => {
                    $('.loader-wraper').fadeIn(100)
                    setTimeout(() => document.location.href = '/dumpRoot', 250)
                }
                const goToStart = () => {
                    $('#profileLink').fadeIn(100)
                    $('.loader-wraper').fadeIn(100)
                    setTimeout(() => document.location.href = '/', 250)
                }
                const goToUsr = () => {
                    $('.loader-wraper').fadeIn(100)
                    setTimeout(() => document.location.href = '/adminUser', 250)
                }
                function validarLetras(e) {
                    var tecla = (document.all) ? e.keyCode : e.which;
                    if (tecla == 8) return true;
                    var patron = /^([^0-9]*)$/;
                    var te = String.fromCharCode(tecla);
                    return patron.test(te);
                }

                let user = {};
                let tipo = false;
                //------------------------------------------------------------------------------
                //metodo que consulta todos los roles disponibles

                //------------------------------------------------------------------------------

                //------------------------------------------------------------------------------

                //------------------------------------------------------agregar un nuevo usuario

                const updatePass = () => {
                    if ($('#passNew').val() != '' && $('#passNewR').val() != '' && $('#passOld').val() != '' && $('#passNew').val() == $('#passNewR').val() && $('#passNew').val() != $('#passOld').val())
                        return $.ajax({
                            type: 'PUT',
                            url: './api/user/auth',
                            data: {
                                password: $("#passNew").val(),
                                oldPassword: $("#passOld").val()
                            }
                        }).done(response => {
                            if (response == 'OK') {
                                hotsnackbar('hsdone', "contraseña modificada!.")
                            }
                        }).fail((response) => {
                            switch (response.status) {
                                case 401:
                                    $("#passOld").addClass('error')
                                    hotsnackbar('hserror', "contraseña incorrecta!.")
                                    break
                                default:
                                    hotsnackbar('hserror', "Parece que el servidor no responde..")
                            }
                        })
                    if ($('#passOld').val() == '') {
                        $('#passOld').addClass('error')
                        return hotsnackbar('hserror', 'Debe proveer la contraseña actual!')
                    }
                    if ($('#passNew').val() != $('#passNewR').val()) {
                        $('#passNew').addClass('error')
                        $('#passNewR').addClass('error')
                        return hotsnackbar('hserror', 'Estos campos deben ser iguales!')
                    }
                    if ($('#passNew').val() == $('#passOld').val()) {
                        $('#passNew').addClass('error')
                        $('#passOld').addClass('error')
                        $('#passNewR').addClass('error')
                        return hotsnackbar('hserror', 'La nueva contraseña debe ser distinta de la actual!')
                    }
                    $('#passNew').addClass('error')
                    $('#passNewR').addClass('error')
                    hotsnackbar('hserror', 'Debes proveer la nueva contraseña!')
                }

                const enviar = () => {
                    if (validar())
                        $.ajax({
                            type: 'PUT',
                            url: './api/user/',
                            data: {
                                name: $("#nombre").val(),
                                email: $("#correo").val()
                            }
                        }).done(response => {
                            if (response == 'OK') {
                                $('#usrName').html(`Modificacion de usuario | <b>${$("#nombre").val()}</b>`);
                                hotsnackbar('hsdone', "Datos modificados!.")
                            }
                        }).fail((response) => {
                            switch (response.status) {
                                case 400:
                                    $("#correo").addClass('error')
                                    hotsnackbar('hserror', "el correo ya se encuentra registrado, contacte a soporte.")
                                    break
                                default:
                                    hotsnackbar('hserror', "Parece que el servidor no responde..")
                            }
                        })
                    else
                        hotsnackbar('hserror', errorText)
                }

                var errorText;
                const validar = () => {
                    if (checkUserChange({
                        name: $("#nombre").val(),
                        email: $("#correo").val()
                    })) {
                        $("#nombre").addClass('error')
                        $("#correo").addClass('error')
                        errorText = "Debe modificar sus datos!"
                        return false;
                    }
                    var correcto = true;
                    $("#nombre").removeClass("error");
                    $("#correo").removeClass("error");

                    if ($("#nombre").val() === "" || $("#nombre").val().length > 50) {
                        $("#nombre").addClass("error");
                        correcto = false;
                    }
                    if ($("#correo").val() === "" || $("#correo").val().length > 50) {
                        $("#correo").addClass("error");
                        correcto = false;
                    }
                    if (!validarCorreo($("#correo").val()) || $("#correo").val().length > 50) {
                        $("#correo").addClass("error");
                        correcto = false;
                        errorText = "debe introducir un correo valido"
                    }

                    return correcto;
                }

                const checkUserChange = u => u.name == user.name && u.email == user.email

                function limpiarForm() {
                    document.getElementById("form_usuario").reset();
                    $("#pass").removeClass("error")
                    $("#nombre").removeClass("error");
                    $("#correo").removeClass("error");
                }

                const validarCorreo = val => /^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,3})+$/.test(val)
            </script>
</body>

</html>
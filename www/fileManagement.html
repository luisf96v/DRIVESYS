<!DOCTYPE HTML>
<html>

<head>
    <meta name="viewport" content="width=device-width" />
    <title>DOCSYS - mantenimiento archivos</title>
    <script src="//code.jquery.com/jquery-1.11.1.min.js"></script>
    <link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.0/css/bootstrap.min.css" rel="stylesheet" id="bootstrap-css">
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.0/js/bootstrap.min.js"></script>
    <link href="/stylesheets/indexUsr.css" rel="stylesheet" type="text/css" />
    <link href="/stylesheets/style.css" rel="stylesheet" type="text/css" />
    <link href="stylesheets/general.css" rel="stylesheet" type="text/css" />
    <link href="stylesheets/tooltip.css" rel="stylesheet" type="text/css" />
    <link href="stylesheets/snackbar.css" rel="stylesheet" type="text/css" />
    <!--link href="/javascripts/jquerySimpleFilePreview/jquerySimpleFilePreview.css" rel="stylesheet" type="text/css" /-->
    <script src="/javascripts/modernizr-custom.js" type="text/javascript"></script>
    <script src="/javascripts/DataTables/datatables.js" type="text/javascript"></script>
    <script src="/javascripts/jquerySimpleFilePreview/jquery.simpleFilePreview.js" type="text/javascript"></script>
    <script src="/javascripts/snackbar.js" type="text/javascript"></script>
    <link rel="stylesheet" href="//use.fontawesome.com/releases/v5.3.1/css/all.css">
    <link rel="stylesheet" href="//cdn.datatables.net/1.10.19/css/dataTables.bootstrap4.min.css">
    <link rel="stylesheet" href="//cdn.datatables.net/responsive/2.2.3/css/responsive.bootstrap.min.css">
</head>

<body>
    <nav class="navbar navbar-inverse top-bar navbar-fixed-top">
        <div class="container-fluid">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#myNavbar"
                    id="mnvar" aria-expanded="false">
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button> <span class="menu-icon" id="menu-icon" style="line-height: 30px; width: 50px"><i
                        class="fa fa-bars" aria-hidden="true" id="chang-menu-icon"></i></span>
                <a class="navbar-brand mx-auto mx-auto-top" href="#"
                    style="text-shadow: 0 0 5px black, 0 0 10px rgba(0,0,0,.3);color: white; font-size: 30px; vertical-align: middle; line-height: 30px">DOC<span
                        style="text-shadow: 0 0 3.5px black; color: #3399ff">SYS</span></a>
            </div>
            <div class="collapse navbar-collapse navbar-right" id="myNavbar">
                <ul class="nav navbar-nav">
                    <li class=""><a href="#"><i class="fa fa-refresh"></i> Empezar Tour</a> </li>
                    <li class=""><a href="#"><i class="fa fa-bell"></i> <span class="badge">9</span></a> </li>
                    <li class="dropdown"> <a class="dropdown-toggle" data-toggle="dropdown" data-target="#dropOpt"
                            href="#">Opciones
                        </a>
                    </li>
                    <ul class="dropdown-menu" style="position: absolute" id='dropOpt'>
                        <li> <a href="#"><i class="fa fa-user"></i> Perfil</a> </li>
                        <li> <a href="#"><i class="fa fa-cog"></i> Preferencias</a> </li>
                        <li> <a href="#"><i class="fa fa-power-off"></i> Salir</a> </li>
                    </ul>
                </ul>
            </div>
        </div>
    </nav>
    <!--    top nav end===========-->
    <div class="wrapper" id="wrapper">
        <div class="left-container" id="left-container">
            <!-- begin SIDE NAV USER PANEL -->
            <div class="hide-sidebar" id="show-nav">
                <ul id="side" class="side-nav">
                    <li class="panel">
                        <a id="panel1" href="javascript:;" data-toggle="collapse" data-target="#Dashboard"> <i
                                class="fa fa-home"></i> Inicio
                            <i class="fa fa-chevron-left pull-right" id="arow1"></i> </a>
                        <ul class="collapse nav" id="Dashboard">
                            <li> <a href="" id="history"><i class="fa fa-angle-double-right"></i> Usuarios</a> </li>
                            <li> <a href="" id="bills"><i class="fa fa-angle-double-right"></i> Archivos</a> </li>
                        </ul>
                    </li>
                    <li class="panel">
                        <a id="panel9" href="javascript:;" data-toggle="collapse" data-target="#trash"> <i
                                class="fa fa-trash"></i> Papelera de reciclaje
                        </a>
                    </li>
                </ul>
            </div>
            <!-- END SIDE NAV USER PANEL -->
        </div>
        </div>
        <div class="right-container full-width" id="right-container">
            <div class="container-fluid" id="mainContainer">
                <div class="row">
                    <div class="col-md-12" id='navigation'>
                        <ol class="breadcrumb">
                            <li><i class="fa fa-home"></i><a href=""> Inicio </a></li>
                            <li>Mesa de trabajo</li>
                            <li class="active" onclick="rollback(0, $(this))" >Raíz</li>
                        </ol>
                    </div>

                </div>
                <div class="row">
                    <div class="col-md-12">
                        <div class="main-header">
                            <h2>Mesa de trabajo</h2>
                            <em>Administrador</em>
                        </div>
                    </div>
                </div>
            </div>
            <div class="container-fluid">
                <table id='tableReview' class='table table-striped nowrap'
                    style="width:100%; background-color: white; border: 1px solid #ddd; text-align: left; outline: 2px solid rgb(197, 197, 197);">
                    <thead style="background-color: #337ab7; color: white">
                        <tr>
                            <td style="width:50%">
                                <p>Nombre</p>
                            </td>
                            <td style="min-width: 30px">
                                <p>Tipo</p>
                            </td>
                            <td style="min-width: 50px">
                                <p>Tamaño</p>
                            </td>
                            <td style="min-width: 120px">
                                <p>Fecha de creación</p>
                            </td>
                            <td style="max-width:120px;">
                                <p>Quitar</p>
                            </td>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                    <tfoot style="background-color: #f4faff">
                        <tr style="text-align:center">
                            <td colspan="5" style="padding: 5px;" class='tdfooter'><u style="cursor: pointer;"
                                    id="createFolder"><span
                                        style="display: inline; margin-right: 6px; vertical-align: text-bottom;"><img
                                            src=" /images/050-folder-plus.svg"></img></span><strong>Crear
                                        Carpeta</strong></u>
                            </td>
                        </tr>
                    </tfoot>
                </table>
            </div>
            <div class="container" style="margin-top:30px; text-align: center; cursor: pointer; padding-bottom: 30px">
                <form class="box" method="post" action="" enctype="multipart/form-data">
                    <div class="box__input">
                        <input class="box__file" type="file" name="files[]" id="file"
                            data-multiple-caption="{count} archivos seleccionados: {names}" multiple />
                        <label id='noInput' for="file" style="width: 100%; cursor: pointer"><strong><u>Elige
                                    archivos</u></strong><span class="box__dragndrop"> o arrastralos
                                aquí</span>.</label>
                        <div id='tableDiv' style="margin-bottom: 8px"></div>
                        <button class="box__button btn-danger" type="reset" style='margin: auto;' id='clearForm'>Limpiar</button>
                        <button class="box__button btn-success" type="submit" style='margin: auto;' id='submitForm'>Cargar</button>
                    </div>
                    <div class="box__uploading">Uploading&hellip;</div>
                    <div class="box__success">Done!</div>
                    <div class="box__error">Error! <span></span>.</div>
                </form>
            </div>
        </div>
        <div id="modalRow" class="modal" tabindex="-1" role="dialog">
            <div class="modal-dialog" role="document">
                <div class="modal-content" style="margin-top: calc(50vh - 170px) !important;">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                        <h2 class="modal-title" id="modalTittle">Crear nueva carpeta</h2>
                    </div>
                    <div class="modal-body" style="text-align: center;" id="modalBody">
                        <div class="tooltip">
                            <label for="nombre_usuario">Nombre</label>
                            <input type="text" id="nombre" name="nombre_usuario" maxlength="30">
                            <span class="tooltiptext">Nombre de carpeta</span>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" id='saveC'>Guardar</button>
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                    </div>
                </div>
            </div>
        </div>
        <div id="modalRow1" class="modal" tabindex="-1" role="dialog">
                <div class="modal-dialog" role="document">
                    <div class="modal-content" style="margin-top: calc(50vh - 170px) !important; width: 500px">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                            <h2 class="modal-title" id="modalTittle1"> </h2>
                        </div>
                        <div class="modal-body" style="text-align: center;" id="modalBody1">
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" id='saveC'>Descargar</button>
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                        </div>
                    </div>
                </div>
            </div>
            <div id="modalRow2" class="modal" tabindex="-1" role="dialog">
                    <div class="modal-dialog" role="document">
                        <div class="modal-content" style="margin-top: calc(50vh - 170px) !important;">
                            <div class="modal-header">
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                                <h2 class="modal-title" id="modalTittle2"> </h2>
                            </div>
                            <div class="modal-body" style="text-align: center;" id="modalBody2">
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-primary" id='override'>Si</button>
                                <button type="button" class="btn btn-secondary" id='cancel'>No</button>
                            </div>
                        </div>
                    </div>
                </div>
        <script>
            var isAdvancedUpload = function () {
                var div = document.createElement('div');
                return (('draggable' in div) || ('ondragstart' in div && 'ondrop' in div)) && 'FormData' in window && 'FileReader' in window;
            }();

            function returnFileSize(number) {
                if (number < 1024) {
                    return number + 'bytes';
                } else if (number >= 1024 && number < 1048576) {
                    return (number / 1024).toFixed(1) + 'KB';
                } else if (number >= 1048576) {
                    return (number / 1048576).toFixed(1) + 'MB';
                }
            }
            var currentRow = 0;
            window.tree = []
            window.current = 0
            tree[current] = []
            var $form = $('.box');
            var $input = $form.find('input[type="file"]'),
                $label = $form.find('label'),
                $files = [],
                showFiles = function (files) {
                    if (files.length > 0) {
                        $label.html('<strong><u>Puedes seguir eligiendo</u> archivos o arrastrandolos aquí</strong>')
                        let table = $("<div class='container' style='max-width: 100%;'/>").append(
                            $("<table id='tableUpload' class='table table-striped' style='display: table; margin: auto; text-align: left; outline: 2px solid rgb(197, 197, 197);'/>").append(tableFromDataRemovable(files))
                        )
                        $('#tableDiv').html(table);
                        $('.box__button').css("display", "inline-table");
                    }
                };

            const tableFromDataRemovable = files => Array.from(files)
                .reduce((z, e, i, arr) => z +
                    "<tr><td>" +
                    e.name +
                    "</td><td>" +
                    (e.name.split('.').length == 1 ? 'Archivo' : e.name.split('.').pop()) +
                    "</td><td>" +
                    returnFileSize(e.size) +
                    "</td><td><span class='fa fa-window-close' style='margin-left:10%; color: #FF5722' onclick='deleteFile(`" + e.name + "`, $(this))'></span></td></tr>" +
                    (i == arr.length - 1 ? "</tbody>" : ""),
                    '<thead style="background-color: #337ab7; color: white"> <tr><td style="width:70%">Nombre</td><td>Tipo</td><td>Tamaño</td><td>Quitar</td></tr></thead><tbody>')

            const deleteFile = (name, element) => {
                $files = $files.filter(e => e.name != name)
                element.parent().parent().remove()
                if ($('#tableUpload tr').toArray().length == 1) {
                    $('#tableDiv').html("")
                    $('.box__button').css("display", "none");
                    $label.html('<strong><u>Elige archivos</u></strong><span class="box__dragndrop"> o arrastralos aquí</span>.')
                }
            }
            const deleteRow = element => {//delete from db
                t.row(element.parents('tr')).remove().draw();
            }
            const rollback = (before, element) => {
                if(!element.hasClass('active')){
                    t.clear()
                    current = before;
                    tree[before].forEach(e=>t.row.add(e).draw(false));
                    updateTableListener();
                    element.parent().children().toArray().slice(before+3).forEach(e=>$(e).remove());
                    element.addClass('active')
                }
            }

            const validarLetras = e => {
                var tecla = (document.all) ? e.keyCode : e.which;
                if (tecla == 8) return true;
                var patron = /^([0-9]*)$/;
                var te = String.fromCharCode(tecla);
                return patron.test(te);
            }
            const solveConflicts = (first = true, type = true) => {
                if(first)
                    window.rejectedConflicts = []
                else if(type)
                    conflicts.shift()
                else
                    rejectedConflicts.push(conflicts.shift())
                sendData(false)
            }
            const askModal = () => {
                $('#modalTittle2').html("Atención")
                $('#modalBody2').html("¿Desea sobreescribir el archivo "+conflicts[0].name+"?")
                $('#modalRow2').modal()
            }
            const monthNames = ["Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic"];

            const sendData = (first = true) => {
                if(first){
                    window.conflicts = $files.filter(e=>tree[current].some(ac=>ac[0].split('&nbsp')[1].split("<")[1].split(">")[1] == e.name))
                    solveConflicts()
                }
                else if(conflicts.length){
                    askModal()
                }else{
                    let dateCreation = ''
                    let today = new Date()
                    let row = []
                    let imgExt = undefined;
                    //console.log("archivos a mandar")
                    //console.log($files.filter(e=>!rejectedConflicts.some(r=>r==e)))
                    $files.filter(e=>!rejectedConflicts.some(r=>r==e)).forEach(f => {
                        today = new Date(f.lastModified)
                        dateCreation = today.getDate()+' de '+monthNames[today.getMonth()]+', '+today.getFullYear()
                        imgExt = setImage(f.name.split('.').pop())
                        if(imgExt){
                            row = ['<span style="display: inline; margin-right: 6px; vertical-align: text-bottom;"><img src="/images/'+imgExt+'" style="display: inline-block"></img>&nbsp<p style="display: inline-block;word-wrap: break-word; word-break: break-all; white-space: normal">' + f.name + '</p></span>', f.name.split('.').pop(), returnFileSize(f.size), dateCreation, "<span class='fa fa-window-close' style='margin-left:calc(50% - 20px); color: #FF5722' onclick='deleteRow($(this))'></span>"]
                            if(!tree[current].some(e=>e[0]==row[0])){
                                t.row.add(row).draw(false);
                                tree[current].push(row)
                                updateTableListener()
                            }
                        }
                    })  
                }
                
            }
            const setImage = ext => {
                switch(ext){
                    case 'jpg':
                    case 'png':
                    case 'gif':
                    case 'JPG':
                    case 'PNG':
                    case 'GIF':
                        return '040-file-picture.svg'
                        break
                    case 'pdf':
                    case 'PDF':
                        return '480-file-pdf.svg'
                        break
                    case 'doc':
                    case 'docx':
                    case 'DOC':
                    case 'DOCX':
                        return '482-file-word.svg'
                        break
                    case 'txt':
                    case 'TXT':
                        return '039-file-text2.svg'
                        break
                    default:
                        return undefined;
                }
            }

            var clicks = 0
            const updateTableListener = () =>
                $('#tableReview tbody tr td').unbind('click').on('click',e => {
                    clicks++;
                    let x = $(e.target).parent().children().toArray()
                    console.log(x)
                    console.log((x[1].innerHTML+"").toLowerCase())
                    if(clicks>=2&&(x[1].innerHTML+"").toLowerCase()=='carpeta'){
                        clearTimeout()
                        current++
                        tree[current] = []
                        $('.breadcrumb li').removeClass("active");
                        $($('.breadcrumb').toArray()[0]).append($("<li class='active' onclick=rollback("+current+",$(this))/>").append($(e.target).parent().children().first()[0].firstChild.innerText))
                        t.clear().draw()
                    }
                    setTimeout(()=>{clicks=0},500)
                    if((x[1].innerHTML+"").toLowerCase()!='carpeta'){
                        insertDataDM($(e.target).parent().children().toArray().map(e => $(e)))
                    }
                }).contextmenu(e=>{
                    e.preventDefault();
                })
            const insertDataDM = (e) => {
                $("#modalTittle1").html("Dialogo de descarga")
                e.pop()
                $("#modalBody1").html(getTableData(e))
                $("#modalRow1").modal()
            }
            const getTableData = info => {
                colNames = ['Nombre','Tipo', 'Tamaño', 'Última modificación']
                data = info.reduce((z, e, i) => z + '<tr><td>' + colNames[i] + ':' + '</td><td>' + (i==0 ? e.children().last()[0].innerHTML: e.html()) + '</td></tr>', "")
                return $("<div class='container' style='max-width: 90%'/>").append($('<table class="table table-bordered" style="max-width: 100%"/>').append(data)[0])
            }
            $('document').ready(() => {
                window.t = $('#tableReview').DataTable({
                    fixedHeader: {
                        header: true,
                        footer: true
                    },
                    "columnDefs": [
                        { "orderable": false, "targets": 4 }
                    ],
                    language: {
                        "sProcessing": "Procesando...",
                        "sLengthMenu": "Mostrar _MENU_ registros",
                        "sZeroRecords": "No se encontraron resultados",
                        "sEmptyTable": "Ningún dato disponible en esta tabla",
                        "sInfo": "Mostrando registros del _START_ al _END_ de un total de _TOTAL_ registros",
                        "sInfoEmpty": "Mostrando registros del 0 al 0 de un total de 0 registros",
                        "sInfoFiltered": "(filtrado de un total de _MAX_ registros)",
                        "sInfoPostFix": "",
                        "sSearch": "Buscar:",
                        "sUrl": "",
                        "sInfoThousands": ",",
                        "sLoadingRecords": "Cargando...",
                        "oPaginate": {
                            "sFirst": "Primero",
                            "sLast": "Último",
                            "sNext": "Siguiente",
                            "sPrevious": "Anterior"
                        },
                        "oAria": {
                            "sSortAscending": ": Activar para ordenar la columna de manera ascendente",
                            "sSortDescending": ": Activar para ordenar la columna de manera descendente"
                        }
                    }
                });
                $('#override').click(e=>{
                    solveConflicts(false)
                    if(!conflicts.length)
                        $('#modalRow2').modal('toggle')
                })
                $('#cancel').click(e=>{
                    e.preventDefault()
                    solveConflicts(false, false)
                    if(!conflicts.length)
                        $('#modalRow2').modal('toggle')
                })
                $('#submitForm').click(e=>{
                    e.preventDefault()
                    sendData()
                })
                updateTableListener()
                $('#tableReview_info').html("<p style='word-wrap: break-word; word-break: normal; white-space: normal'>"+$('#tableReview_info').html()+"</p>")
                
                
                $('#foldertd').css('display', 'table-cell !important')
                $('#createFolder').click(e => {
                    e.preventDefault()
                    $('#modalRow').modal()
                })
                
                $('#saveC').click(() => {
                    if (t
                        .data()
                        .toArray()
                        .toString()
                        .toLowerCase()
                        .split(',')
                        .indexOf('<span style="display: inline; margin-right: 6px; vertical-align: text-bottom;"><img src="/images/048-folder.svg"></img>&nbsp' + $('#nombre').val() + '</span>'.toLowerCase()) == -1) {
                        let today = new Date()
                        let dateCreation = today.getDate()+' de '+monthNames[today.getMonth()]+', '+today.getFullYear()
                        t.row.add(['<span style="display: inline; margin-right: 6px; vertical-align: text-bottom;"><img src="/images/048-folder.svg"></img>&nbsp' + $('#nombre').val() + '</span>', 'Carpeta', '––', dateCreation, "<span class='fa fa-window-close' style='margin-left:calc(50% - 20px); color: #FF5722' onclick='deleteRow($(this))'></span>"]).draw(false);
                        tree[current].push(['<span style="display: inline; margin-right: 6px; vertical-align: text-bottom;"><img src="/images/048-folder.svg"></img>&nbsp' + $('#nombre').val() + '</span>', 'Carpeta', '––', dateCreation, "<span class='fa fa-window-close' style='margin-left:calc(50% - 20px); color: #FF5722' onclick='deleteRow($(this))'></span>"])
                        $('#modalRow').modal('toggle');
                        updateTableListener()
                        hotsnackbar('hsdone', 'se ha creado la carpeta.')
                    }
                    else {
                        if ($('#nombre').val().length == 0)
                            hotsnackbar('hserror', 'el nombre no puede ser vacío!')
                        else
                            hotsnackbar('hserror', 'el nombre de carpeta ya existe!')
                    }
                })

                $('#clearForm').click(e => {
                    e.preventDefault()
                    $('#tableDiv').html("")
                    $('.box__button').css("display", "none");
                    $files = []
                    $label.html('<strong><u>Elige archivos</u></strong><span class="box__dragndrop"> o arrastralos aquí</span>.')
                })
                $input.on('change', function (e) {
                    $files = Array.from(e.originalEvent.target.files).reduce((z, e) => ($files.some(n => n.name == e.name) || (!e.type && e.size % 4096 == 0)) ? z : z.concat(e), $files)
                    showFiles($files);
                });
                if (isAdvancedUpload) {
                    $("#file").hide();
                    $("#noInput").show();
                    $form.addClass('has-advanced-upload');
                    var droppedFiles = false;

                    $form.on('drag dragstart dragend dragover dragenter dragleave drop', function (e) {
                        e.preventDefault();
                        e.stopPropagation();
                    })
                        .on('dragover dragenter', function () {
                            $form.addClass('is-dragover');
                        })
                        .on('dragleave dragend drop', function () {
                            $form.removeClass('is-dragover');
                        })
                        .on('drop', function (e) {
                            console.log(e.originalEvent.dataTransfer.files)
                            $files = Array.from(e.originalEvent.dataTransfer.files).reduce((z, e) => ($files.some(n => n.name == e.name) || (!e.type && e.size % 4096 == 0)) ? z : z.concat(e), $files)
                            showFiles($files);
                        });

                } else {
                    $("#file").show();
                    $("#noInput").hide();
                }
            })

        </script>
        <script src="/javascripts/indexUsr.js" type="text/javascript"></script>

</html>
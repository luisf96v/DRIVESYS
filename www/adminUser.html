<!DOCTYPE HTML>
<html>

<head>
    <meta name="viewport" content="width=device-width" />
    <title>DOCSYS - visualizacion de archivos</title>
    <script src="//code.jquery.com/jquery-1.11.1.min.js"></script>
    <link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.0/css/bootstrap.min.css" rel="stylesheet" id="bootstrap-css">
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.0/js/bootstrap.min.js"></script>
    <link href="/stylesheets/indexUsr.css" rel="stylesheet" type="text/css" />
    <link href="/stylesheets/style.css" rel="stylesheet" type="text/css" />
    <link href="stylesheets/general.css" rel="stylesheet" type="text/css" />
    <link href="stylesheets/tooltip.css" rel="stylesheet" type="text/css" />
    <link href="stylesheets/snackbar.css" rel="stylesheet" type="text/css" />
    <!--link href="/javascripts/jquerySimpleFilePreview/jquerySimpleFilePreview.css" rel="stylesheet" type="text/css" /-->
    <script src="/javascripts/modernizr-custom.js" type="text/javascript"></script>
    <script src="/javascripts/DataTables/datatables.js" type="text/javascript"></script>
    <script src="/javascripts/jquerySimpleFilePreview/jquery.simpleFilePreview.js" type="text/javascript"></script>
    <script src="/javascripts/snackbar.js" type="text/javascript"></script>
    <script src="/javascripts/global.js" type="text/javascript"></script>
    <link rel="stylesheet" href="//use.fontawesome.com/releases/v5.3.1/css/all.css">
    <link rel="stylesheet" href="//cdn.datatables.net/1.10.19/css/dataTables.bootstrap4.min.css">
    <link rel="stylesheet" href="//cdn.datatables.net/responsive/2.2.3/css/responsive.bootstrap.min.css">
</head>

<body>
    <div class="loader-wraper">
        <div class="loader">
            <div class="duo duo1">
                <div class="dot dot-a"></div>
                <div class="dot dot-b"></div>
            </div>
            <div class="duo duo2">
                <div class="dot dot-a"></div>
                <div class="dot dot-b"></div>
            </div>
            <br /><br />
            <p>Cargando...</p>
        </div>
        <div style="text-align: center; margin-top: calc(100vh - 80px);">
            <p>Recargue la pagina si este mensaje no desaparece en 5 segundos.</p>
        </div>
    </div>
    <nav class="navbar navbar-inverse top-bar navbar-fixed-top">
        <div class="container-fluid">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#myNavbar"
                    id="mnvar" aria-expanded="false">
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button> <span class="menu-icon" id="menu-icon" style="line-height: 30px; width: 50px"><i
                        class="fa fa-bars" aria-hidden="true" id="chang-menu-icon"></i></span>
                <a class="navbar-brand mx-auto mx-auto-top" href="http://localhost:3000"
                    style="text-shadow: 0 0 5px black, 0 0 10px rgba(0,0,0,.3);color: white; font-size: 30px; vertical-align: middle; line-height: 30px">DOC<span
                        style="text-shadow: 0 0 3.5px black; color: #3399ff">SYS</span></a>
            </div>
            <div class="collapse navbar-collapse navbar-right" id="myNavbar">
                <ul class="nav navbar-nav">
                    <li class=""><a href="#"><i class="fa fa-refresh"></i> Empezar Tour</a> </li>
                    <li class=""><a href="#"><i class="fa fa-bell"></i> <span class="badge">9</span></a> </li>
                    <li class="dropdown"> <a class="dropdown-toggle" data-toggle="dropdown" data-target="#dropOpt"
                            href="#">Opciones
                        </a>
                    </li>
                    <ul class="dropdown-menu" style="position: absolute" id='dropOpt'>
                        <li> <a href="#"><i class="fa fa-user"></i> Perfil</a> </li>
                        <li> <a href="#"><i class="fa fa-cog"></i> Preferencias</a> </li>
                        <li> <a href="javascript:logout()"><i class="fa fa-power-off"></i> Salir</a> </li>
                    </ul>
                </ul>
            </div>
        </div>
    </nav>
    <!--    top nav end===========-->
    <div class="wrapper" id="wrapper">
        <div class="left-container" id="left-container">
            <!-- begin SIDE NAV USER PANEL -->
            <div class="hide-sidebar" id="show-nav">
                <ul id="side" class="side-nav">

                </ul>
            </div>
            <!-- END SIDE NAV USER PANEL -->
        </div>
    </div>
    <div class="right-container full-width" id="right-container">
        <div class="container-fluid" id="mainContainer">
            <div class="row">
                <div class="col-md-12" id='navigation'>
                    <ol class="breadcrumb">
                        <li><i class="fa fa-home"></i><a href=""> Inicio </a></li>
                        <li>Mesa de trabajo</li>
                    </ol>
                </div>

            </div>
            <div class="row">
                <div class="col-md-12">
                    <div class="main-header">
                        <h2>Mesa de trabajo</h2>
                        <em>Usuarios</em>
                    </div>
                </div>
            </div>
        </div>
        <style>
            #tableReview tbody tr td:last-child {
                text-align: center;
            }
        </style>
        <div class="container-fluid">
            <table id='tableReview' class='table table-striped nowrap'
                style="width:100%; background-color: white; border: 1px solid #ddd; text-align: left; outline: 2px solid rgb(197, 197, 197);">
                <thead style="background-color: #337ab7; color: white">
                    <tr>
                        <td style="width:50%">
                            <p>Correo</p>
                        </td>
                        <td style="width: 20%">
                            <p style="text-align: left">Nombre</p>
                        </td>
                        <td style="width: 20%">
                            <p style="text-align: left">Rol</p>
                        </td>
                        <td style="min-width:220px">
                            <p>Acciones</p>
                        </td>
                    </tr>
                </thead>
                <tbody>
                </tbody>
                <tfoot style="background-color: #f4faff">
                    <tr style="text-align:center">
                        <td colspan="4" style="padding: 5px;" class='tdfooter'><u style="cursor: pointer;"
                                id="createFolder"><span
                                    style="display: inline; margin-right: 6px; vertical-align: text-bottom;"><img
                                        src=" /images/116-user-plus.svg"></img></span><strong>Nuevo Usuario</strong></u>
                        </td>
                    </tr>
                </tfoot>
            </table>
        </div>
        <div id="modalRow" class="modal" tabindex="-1" role="dialog">
            <div class="modal-dialog" role="document">
                <div class="modal-content" style="margin-top: calc(50vh - 170px) !important;">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                        <h2 class="modal-title" id="modalTittle">Crear Nuevo Usuario</h2>
                    </div>
                    <div class="modal-body" style="text-align: right;" id="modalBody">
                        <div class="tooltip">
                            <label for="correo_usuario">Correo de usuario</label>&nbsp;&nbsp;
                            <input type="text" id="correo" name="correo_usuario">
                            <span class="tooltiptext">Usuario con el que se iniciará sesión
                                `example@example.com`</span>
                        </div>
                        <div class="tooltip">
                            <label for="nombre_usuario">Nombre de Usuario</label>&nbsp;&nbsp;
                            <input type="text" id="nombre" name="nombre_usuario"
                                onkeypress="return validarLetras(event)">
                            <span class="tooltiptext">Nombre del usuario</span>
                        </div>
                        <div class="tooltip">
                            <label for="tipo">Rol del usuario</label>&nbsp;&nbsp;
                            <select id="tipo">
                                <option value="2" active>Visualizador</option>
                                <option value="1">Sub-administrador</option>
                                <option value="3" hidden="hidden">Administrador</option>
                            </select>
                            <span class="tooltiptext">Rol del usuario</span>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" id='saveC'>Guardar</button>
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                    </div>
                </div>
            </div>
        </div>
        <div id="menuCapa" class="menuCapa">
            <div style='width: 95%; margin: auto'>
                <a class="visto marca" id="edit" href="#">Editar usuario</a>
                <a class="visto marca" id="reset" href="#">Resetear contraseña</a>
            </div>
        </div>
        <script>

            var currentRow = 0;

            const deleteRow = element => {//delete from db
                t.row(element.parents('tr')).remove().draw();
            }
            const getRol = rol => rol == 1 || rol == 4 ? 'Administrador' : rol == 2 || rol == 5 ? 'Sub-administrador' : 'Visualizador'

            const validarLetras = e => {
                var tecla = (document.all) ? e.keyCode : e.which;
                if (tecla == 8) return true;
                var patron = /^([^0-9]*)$/;
                var te = String.fromCharCode(tecla);
                return patron.test(te);
            }
            window.editing = false
            window.currentRow = undefined
            window.currentElement = undefined
            function showMenu(e) {
                e.preventDefault()
                if (!$(e.target).hasClass("dataTables_empty")) {
                    let deltaY = 0
                    let deltaX = 79
                    if (e.clientY > 64)
                        deltaY = 9
                    $('#menuCapa').css({ 'left': e.clientX - deltaX, 'top': e.clientY - deltaY })
                    $(e.target).closest("tr")[0].getAttribute('data-passr') == 'true' ? $('#reset').addClass('anch-dis') : $('#reset').removeClass('anch-dis')
                    $('#menuCapa').show()
                    currentRow = $(e.target).closest("tr")
                    currentElement = e.target
                }
            }
            const resetUser = e => {
                console.log(e[0])
                fetch('/api/user/reset', {
                    method: 'PUT',
                    body: JSON.stringify({
                        id: e[0].id
                    }),
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                }).then(res => {
                    if (res.status == 200) {
                        e[0].setAttribute('data-passr', true)
                        e[0].lastChild.innerHTML = `<button style='margin-left:5px' class='btn btn-danger btn-xs' onclick='' disabled=true>Resetear contraseña</button>`
                        return
                    }
                    if (res.status == 403) {
                        hotsnackbar('hserror', 'No tienes los permisos para realizar esta acción!')
                        return
                    }
                }).catch(console.log)
            }


            const solveConflicts = (first = true, type = true) => {
                if (first)
                    window.rejectedConflicts = []
                else if (type)
                    conflicts.shift()
                else
                    rejectedConflicts.push(conflicts.shift())
                sendData(false)
            }
            const askModal = () => {
                $('#modalTittle2').html("Atención")
                $('#modalBody2').html("¿Desea sobreescribir el archivo " + conflicts[0].name + "?")
                $('#modalRow2').modal()
            }

            const validateInstertOrg = () => {
                flag = true
                error = []
                if (!(/^[a-zA-Z0-9.!#$%&’*+\/=?^_`{|}~-]+@[a-zA-Z0-9]+(?:\.([a-zA-Z0-9]{2,3}))+$/.test($('#correo').val()))) {
                    $('#correo').addClass('error')
                    error.push('Correo&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp')
                    flag = false
                }
                if ($('#nombre').val() == "") {
                    $('#nombre').addClass('error')
                    error.push('Nombre del usuario &nbsp&nbsp')
                    flag = false
                }
                if (!flag)
                    hotsnackbar('hserror', error.reduce((z, e, i, a) => i + 1 < a.length ? z + '- ' + e + '<br>' : z + '- ' + e, "Error con: <br>"))
                return flag
            }
            const setImage = ext => {
                switch (ext) {
                    case 'jpg':
                    case 'png':
                    case 'gif':
                        return '040-file-picture.svg'
                        break
                    case 'pdf':
                        return '480-file-pdf.svg'
                        break
                    case 'doc':
                    case 'docx':
                        return '482-file-word.svg'
                        break
                    case 'txt':
                        return '039-file-text2.svg'
                        break
                    default:
                        return undefined;
                }
            }

            const getUserType = type => {
                switch (type) {
                    case 1:
                        return 'Administrador:'
                    case 2:
                        return 'Sub-administrador:'
                    case 4:
                        return 'Administrador de organización:'
                    case 5:
                        return 'Sub-administrador de organización:'
                    default:
                        return 'Intruso:'
                }
            }

            var clicks = 0
            const updateTableListener = () => $('#tableReview tbody tr td').contextmenu(showMenu)
            const getTableData = info => {
                colNames = ['Nombre', 'Tipo', 'Tamaño', 'Última modificación']
                data = info.reduce((z, e, i) => z + '<tr><td>' + colNames[i] + ':' + '</td><td>' + (i == 0 ? e.children().last()[0].innerHTML : e.html()) + '</td></tr>', "")
                return $("<div class='container' style='max-width: 90%'/>").append($('<table class="table table-bordered" style="max-width: 100%"/>').append(data)[0])
            }
            $('document').ready(() => {
                fetch('/admUsrNav', {
                    method: 'GET'
                }).then(async e => {
                    nav = await e.text()
                    $("#side-nav").html(nav)
                });
                [$('#nombreO'), $('#correo'), $('#nombre')].forEach(e => e.hover(r => $(r.target).removeClass('error')))
                var menu = $('#menuCapa')
                menu.mouseleave(function () { menu.hide() })
                window.t = $('#tableReview').DataTable({
                    fixedHeader: {
                        header: true,
                        footer: true
                    },
                    columnDefs: [
                        { "orderable": false, "targets": 3 }
                    ],
                    language: {
                        "sProcessing": "Procesando...",
                        "sLengthMenu": "Mostrar _MENU_ registros",
                        "sZeroRecords": "No se encontraron resultados",
                        "sEmptyTable": "Ningún dato disponible en esta tabla",
                        "sInfo": "Mostrando registros del _START_ al _END_ de un total de _TOTAL_ registros",
                        "sInfoEmpty": "Mostrando registros del 0 al 0 de un total de 0 registros",
                        "sInfoFiltered": "(filtrado de un total de _MAX_ registros)",
                        "sInfoPostFix": "",
                        "sSearch": "Buscar:",
                        "sUrl": "",
                        "sInfoThousands": ",",
                        "sLoadingRecords": "Cargando...",
                        "oPaginate": {
                            "sFirst": "Primero",
                            "sLast": "Último",
                            "sNext": "Siguiente",
                            "sPrevious": "Anterior"
                        },
                        "oAria": {
                            "sSortAscending": ": Activar para ordenar la columna de manera ascendente",
                            "sSortDescending": ": Activar para ordenar la columna de manera descendente"
                        }
                    },
                    'ajax': {
                        url: `/api/user`,
                        method: 'get',
                        dataSrc: data => {
                            return data.map(e => {
                                return [e.email,
                                e.name,
                                getRol(e.type),
                                e.passr ? `<button style='margin-left:5px' class='btn btn-danger btn-xs' onclick='' disabled=true>Resetear contraseña</button>` : `<button style='margin-left:5px' class='btn btn-danger btn-xs' onclick='resetUser($(this).closest("tr"))'>Resetear contraseña</button>`,
                                e._id, e.passr, e.type]
                            })
                        }
                    },
                    "pageLength": 50,
                    "fnCreatedRow": function (nRow, aData, iDataIndex) {
                        $(nRow).attr('id', aData[4]);
                        $(nRow)[0].setAttribute('data-passr', aData[5]);
                        $(nRow)[0].setAttribute('data-type', aData[6]);
                    },
                    'initComplete': () => {
                        $('.loader-wraper').fadeOut()
                        //updateHistory('root')
                        updateTableListener()
                    }
                });
                $('#reset').click(() => !$('#reset').hasClass('anch-dis') && resetUser(currentRow))
                $('#override').click(e => {
                    solveConflicts(false)
                    if (!conflicts.length)
                        $('#modalRow2').modal('toggle')
                })
                $('#cancel').click(e => {
                    e.preventDefault()
                    solveConflicts(false, false)
                    if (!conflicts.length)
                        $('#modalRow2').modal('toggle')
                })
                $('#submitForm').click(e => {
                    e.preventDefault()
                    sendData()
                })
                updateTableListener()
                $('#tableReview_info').html("<p style='word-wrap: break-word; word-break: normal; white-space: normal'>" + $('#tableReview_info').html() + "</p>")


                $('#foldertd').css('display', 'table-cell !important')
                $('#createFolder').click(e => {
                    e.preventDefault()
                    $("#modalTittle").html("Crear Nuevo Usuario")
                    $('#modalRow').modal()
                })

                $('#saveC').click(() => {
                    var tableVec = t.data().toArray()
                    var msg = editing ? ['los datos no pueden permanecer iguales!', 'se ha modificado el usuario.']
                        : ['Hay un correo con conflicto!', 'se ha creado el usuario.']
                    if (validateInstertOrg()) {
                        if (!tableVec.length ||
                            tableVec.every(e => e[0] != $('#correo').val().toLowerCase()) ||
                            (tableVec.some(e => e[0] == $('#correo').val().toLowerCase() && e[1] != $("#nombre").val().toUpperCase())) && editing) {
                            if (editing) {
                                fetch(`/api/user/${currentRow.closest('tr')[0].id}`, {
                                    method: 'PUT',
                                    headers: {
                                        'Accept': 'application/json',
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify({
                                        name: $('#nombre').val(),
                                        email: $('#correo').val(),
                                        type: $('#tipo').val()
                                    })
                                }).then(async res => {
                                    if (res.status == 200) {
                                        newU = await res.json()
                                        console.log(currentRow[0], newU)
                                        t.row(currentRow[0]).remove().draw(false)
                                        refreshTable(newU, msg)
                                        editing = false
                                        return
                                    }
                                    if (res.status == 403) {
                                        hotsnackbar('hserror', 'No tienes los permisos para realizar esta acción!')
                                    }
                                    throw res.message
                                }).catch(console.log)
                                return
                            }
                            fetch(`/api/user/`, {
                                method: 'POST',
                                headers: {
                                    'Accept': 'application/json',
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    name: $('#nombre').val(),
                                    email: $('#correo').val(),
                                    type: $('#tipo').val()
                                })
                            }).then(async res => {
                                if (res.status == 200) {
                                    newU = await res.json()
                                    refreshTable(newU, msg)
                                    return
                                }
                                if (res.status == 400) {
                                    hotsnackbar('hserror', 'ya existe un usuario en el sistema con este correo, contacta a soporte!')
                                }
                                throw res.message
                            }).catch(console.log)
                        }
                        else {
                            if (editing)
                                $("#nombre").addClass('error')
                            $('#correo').addClass('error')
                            hotsnackbar('hserror', msg[0])
                        }
                    }
                })
                $('#edit').click(e => {
                    editing = true;
                    e.preventDefault()
                    window.rowElements = $(currentRow).children().toArray().map(e => $(e))
                    $('#correo').val(rowElements[0].html()).removeClass('error')
                    $("#nombre").val(rowElements[1].html()).removeClass('error')
                    console.log(currentRow[0].getAttribute('data-type'))
                    switch (currentRow[0].getAttribute('data-type')) {
                        case '2': case '5':
                            $("#tipo").val('1')
                            break
                        case '3': case '4':
                            $("#tipo").val('2')
                            break
                        default:
                            $("#tipo").val('3').prop('disabled', true)
                    }
                    $("#modalTittle").html("Modificar Usuario")
                    $('#modalRow').modal()

                })
            })
            const refreshTable = (newU, msg) => {
                t.row.add([
                    newU.email,
                    newU.name,
                    getRol(newU.type),
                    newU.passr ? `<button style='margin-left:5px' class='btn btn-danger btn-xs' onclick='' disabled=true>Resetear contraseña</button>` : `<button style='margin-left:5px' class='btn btn-danger btn-xs' onclick='resetUser($(this).closest("tr"))'>Resetear contraseña</button>`,
                    newU._id, newU.passr
                ]).draw(false);
                $('#modalRow').modal('toggle');
                updateTableListener()
                hotsnackbar('hsdone', msg[1])
            }

        </script>
        <script src="/javascripts/indexUsr.js" type="text/javascript"></script>

</html>